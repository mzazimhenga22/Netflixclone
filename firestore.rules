/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict user-ownership model for user-specific data while allowing public read access to movie data.
 *
 * Data Structure:
 * - /users/{userId}: Stores user account information. The 'userId' MUST match the Firebase auth UID.
 * - /users/{userId}/userProfiles/{profileId}: Stores user profile information. 'userId' MUST match the parent user's ID.
 * - /movies/{movieId}: Stores movie information. Publicly readable.
 * - /users/{userId}/myList/{listItemId}: Stores user's list of saved movies. 'userId' MUST match the parent user's ID.
 * - /users/{userId}/watchingProgress/{progressId}: Stores user's watching progress. 'userId' MUST match the parent user's ID.
 *
 * Key Security Decisions:
 * - User listing is disallowed.
 * - Movie data is publicly readable but not writable (except by backend, which is not covered by these rules).
 * - Default security posture for ambiguous relationships is strict owner-only access.
 *
 * Denormalization for Authorization:
 * - UserProfile, MyList, and WatchingProgress documents all contain a `userId` field that MUST match the `userId` in the path. This denormalization allows for simple owner checks without extra reads.
 *
 * Structural Segregation:
 * - Private user data (profiles, lists, watching progress) is stored under the /users/{userId} path, while public movie data is stored in a top-level /movies collection. This segregation allows for different security rules for each type of data.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Enforces strict user-ownership for user documents.
     * @path /users/{userId}
     * @allow (create) User with auth UID 'user_abc' can create their own user document with id 'user_abc'.
     * @deny (create) User with auth UID 'user_def' cannot create a user document with id 'user_abc'.
     * @deny (update) Any user cannot update any user document (updates are disabled).
     * @deny (delete) Any user cannot delete any user document (deletions are disabled).
     * @principle Enforces document ownership and disables updates/deletions.
     */
    match /users/{userId} {
      //function isExistingOwner(userId) {
      //  return isSignedIn() && isOwner(userId) && resource != null;
      //}
      allow get: if false;
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Enforces strict user-ownership for user profile documents.
     * @path /users/{userId}/userProfiles/{profileId}
     * @allow (create) User with auth UID 'user_abc' can create a profile under /users/user_abc/userProfiles/profile_123.
     * @allow (update) User with auth UID 'user_abc' can update a profile under /users/user_abc/userProfiles/profile_123.
     * @allow (delete) User with auth UID 'user_abc' can delete a profile under /users/user_abc/userProfiles/profile_123.
     * @deny (create) User with auth UID 'user_def' cannot create a profile under /users/user_abc/userProfiles/profile_123.
     * @deny (update) User with auth UID 'user_def' cannot update a profile under /users/user_abc/userProfiles/profile_123.
     * @deny (delete) User with auth UID 'user_def' cannot delete a profile under /users/user_abc/userProfiles/profile_123.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/userProfiles/{profileId} {
      function isExistingOwner(userId) {
        return isSignedIn() && isOwner(userId) && resource != null;
      }
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows public read access to movie documents, but restricts writes.
     * @path /movies/{movieId}
     * @allow (get) Any user (signed in or not) can read movie data.
     * @allow (list) Any user (signed in or not) can list movie data.
     * @deny (create) No user can create movie documents through client-side rules.
     * @deny (update) No user can update movie documents through client-side rules.
     * @deny (delete) No user can delete movie documents through client-side rules.
     * @principle Allows public read access but restricts writes.
     */
    match /movies/{movieId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Enforces strict user-ownership for MyList documents.
     * @path /users/{userId}/myList/{listItemId}
     * @allow (create) User with auth UID 'user_abc' can create a list item under /users/user_abc/myList/list_123.
     * @allow (update) User with auth UID 'user_abc' can update a list item under /users/user_abc/myList/list_123.
     * @allow (delete) User with auth UID 'user_abc' can delete a list item under /users/user_abc/myList/list_123.
     * @deny (create) User with auth UID 'user_def' cannot create a list item under /users/user_abc/myList/list_123.
     * @deny (update) User with auth UID 'user_def' cannot update a list item under /users/user_abc/myList/list_123.
     * @deny (delete) User with auth UID 'user_def' cannot delete a list item under /users/user_abc/myList/list_123.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/myList/{listItemId} {
      function isExistingOwner(userId) {
        return isSignedIn() && isOwner(userId) && resource != null;
      }
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces strict user-ownership for WatchingProgress documents.
     * @path /users/{userId}/watchingProgress/{progressId}
     * @allow (create) User with auth UID 'user_abc' can create a progress entry under /users/user_abc/watchingProgress/progress_123.
     * @allow (update) User with auth UID 'user_abc' can update a progress entry under /users/user_abc/watchingProgress/progress_123.
     * @allow (delete) User with auth UID 'user_abc' can delete a progress entry under /users/user_abc/watchingProgress/progress_123.
     * @deny (create) User with auth UID 'user_def' cannot create a progress entry under /users/user_abc/watchingProgress/progress_123.
     * @deny (update) User with auth UID 'user_def' cannot update a progress entry under /users/user_abc/watchingProgress/progress_123.
     * @deny (delete) User with auth UID 'user_def' cannot delete a progress entry under /users/user_abc/watchingProgress/progress_123.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/watchingProgress/{progressId} {
      function isExistingOwner(userId) {
        return isSignedIn() && isOwner(userId) && resource != null;
      }
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }
  }
}