/**
 * @fileoverview Firestore Security Rules for the application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model. Each user can create and manage their own data,
 * including profiles, watchlists, and watch history, under their specific user ID.
 *
 * Data Structure:
 * All data is nested under /users/{userId}, providing clear ownership and segregation.  Each user can have
 * multiple profiles, and each profile has its own watchlist and watch history.
 *
 * Key Security Decisions:
 * - Users can only list their own profiles.
 * - Users have full control over their own watchlists and history.
 * - Data validation is limited to ensuring data consistency between the path and the document's internal fields.
 * - Denormalization: No denormalization is needed, as all rules operate within a user's data tree.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profiles. Each user can create, read, update, and delete their own profiles.
     * @path /databases/{database}/documents/users/{userId}/profiles/{profileId}
     * @allow (create) User with UID 'user123' can create a profile with ID 'user123' under their user ID.
     * @allow (get, list) User with UID 'user123' can read and list their own profiles.
     * @allow (update, delete) User with UID 'user123' can update and delete their own profiles.
     * @deny (create) User with UID 'user123' cannot create a profile with ID 'otherUser' under their user ID.
     * @deny (get, list) User with UID 'user456' cannot read or list profiles under user ID 'user123'.
     * @deny (update, delete) User with UID 'user456' cannot update or delete profiles under user ID 'user123'.
     * @principle Enforces document ownership for writes. Restricts access to a user's own data tree. Validates relational integrity between documents.
     */
    match /users/{userId}/profiles/{profileId} {
      // Read permissions
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);

      // Write permissions
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == profileId;
      allow update: if isSignedIn() && isExistingOwner(userId) && resource.data.id == request.resource.data.id;
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Controls access to a user's watchlist.  Each user can create, read, update, and delete items in their own watchlist.
     * @path /databases/{database}/documents/users/{userId}/profiles/{profileId}/myList/{itemId}
     * @allow (create) User with UID 'user123' can create an item in their watchlist.
     * @allow (get, list) User with UID 'user123' can read and list items in their watchlist.
     * @allow (update, delete) User with UID 'user123' can update and delete items in their watchlist.
     * @deny (get, list) User with UID 'user456' cannot read or list items in user 'user123's watchlist.
     * @deny (update, delete) User with UID 'user456' cannot update or delete items in user 'user123's watchlist.
     * @principle Enforces document ownership for writes. Restricts access to a user's own data tree.
     */
    match /users/{userId}/profiles/{profileId}/myList/{itemId} {
      // Read permissions
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);

      // Write permissions
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }

    /**
     * @description Controls access to a user's watch history. Each user can create, read, update, and delete items in their own watch history.
     * @path /databases/{database}/documents/users/{userId}/profiles/{profileId}/history/{itemId}
     * @allow (create) User with UID 'user123' can create an item in their watch history.
     * @allow (get, list) User with UID 'user123' can read and list items in their watch history.
     * @allow (update, delete) User with UID 'user123' can update and delete items in their watch history.
     * @deny (get, list) User with UID 'user456' cannot read or list items in user 'user123's watch history.
     * @deny (update, delete) User with UID 'user456' cannot update or delete items in user 'user123's watch history.
     * @principle Enforces document ownership for writes. Restricts access to a user's own data tree.
     */
    match /users/{userId}/profiles/{profileId}/history/{itemId} {
      // Read permissions
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);

      // Write permissions
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner(userId);
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }
  }

  // Helper functions
  function isSignedIn() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return request.auth.uid == userId;
  }

  function isExistingOwner(userId) {
    return isOwner(userId) && resource != null;
  }
}